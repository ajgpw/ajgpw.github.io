<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>CDN Inline Tool</title>
  <style>
    textarea { width:48%; height:300px; }
    pre { white-space: pre-wrap; background:#eee; padding:10px; height:200px; overflow:auto; }
    button { margin:2px; }
  </style>
</head>
<body>

<textarea id="inputHtml" placeholder="ここにHTMLを入力"></textarea>
<textarea id="outputHtml" placeholder="ここに変換後が出力"></textarea>
<br>

<button id="inlineBtn">インライン化</button>
<button id="clearBtn">クリア</button>
<button id="copyBtn">コピー</button>
<button id="downloadBtn">ダウンロード</button>

<pre id="log"></pre>

<script>
(function(){
  const input = document.getElementById('inputHtml');
  const output = document.getElementById('outputHtml');
  const logEl = document.getElementById('log');

  function log(...msg){
    logEl.textContent = msg.join(' ') + "\n" + logEl.textContent;
  }

  const CDN_REGEX =
    /https?:\/\/cdn\.jsdelivr\.net\/gh\/[^"'>\s]+\/assets\/index-[^"'>\s]+\.(js|css)/ig;

  function findUrls(html){
    const list = [];
    let m;
    while((m = CDN_REGEX.exec(html)) !== null){
      list.push(m[0]);
    }
    return Array.from(new Set(list));
  }

  async function fetchText(url){
    const r = await fetch(url, {credentials:"omit"});
    if(!r.ok) throw new Error(r.status + " " + r.statusText);
    return await r.text();
  }

  function sanitizeScriptContent(js){
    return js.replace(/<\/script>/gi, '<\\/scr' + 'ipt>');
  }

  function sanitizeCssContent(css){
    return css.replace(/<\/style>/gi, '<\\/st' + 'yle>');
  }

  document.getElementById('inlineBtn').addEventListener('click', async ()=>{
    const src = input.value;
    if(!src.trim()){
      log("入力が空です");
      return;
    }
    output.value = "";

    const urls = findUrls(src);
    if(urls.length === 0){
      log("jsDelivr の index-*.js / *.css が見つかりません");
      output.value = src;
      return;
    }

    log("検出:", urls.join(", "));

    const fetched = {};

    await Promise.all(urls.map(async url=>{
      try{
        log("fetch:", url);
        const txt = await fetchText(url);
        fetched[url] = txt;
        log("取得成功:", url);
      }catch(e){
        log("取得失敗:", url, e.message);
        fetched[url] = null;
      }
    }));

    let out = src;

    // ------- CSS -------
    out = out.replace(
      /<link\b[^>]*href=(["'])(https?:\/\/cdn\.jsdelivr\.net\/gh\/[^"'>\s]+\/assets\/index-[^"'>\s]+\.css)\1[^>]*>/ig,
      (match, q, url)=>{
        if(fetched[url] == null) return match;
        const safeCss = sanitizeCssContent(fetched[url]);
        return `<style>/* inlined from: ${url} */\n${safeCss}\n</style>`;
      }
    );

    // ------- JS -------
    out = out.replace(
      /<script\b([^>]*)\bsrc=(["'])(https?:\/\/cdn\.jsdelivr\.net\/gh\/[^"'>\s]+\/assets\/index-[^"'>\s]+\.js)\2([^>]*)>\s*<\/script>/ig,
      (match, before, q, url, after)=>{
        if(fetched[url] == null) return match;
        const safeJs = sanitizeScriptContent(fetched[url]);
        const hasModule = /type\s*=\s*["']module["']/i.test(before + " " + after);
        const typeAttr = hasModule ? ' type="module"' : '';
        return `<script${typeAttr}>\n/* inlined from: ${url} */\n${safeJs}\n</script>`;
      }
    );

    output.value = out;
    log("変換完了");
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    input.value = "";
    output.value = "";
    log("クリアしました");
  });

  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    await navigator.clipboard.writeText(output.value);
    log("コピーしました");
  });

  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const blob = new Blob([output.value], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "inline.html";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    log("ダウンロード開始");
  });

})();
</script>

</body>
</html>
