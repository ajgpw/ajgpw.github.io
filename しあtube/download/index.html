<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>m3u8 Downloader (ffmpeg.wasm)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background: #3b82f6;
      border: none;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #475569;
      cursor: not-allowed;
    }
    pre {
      background: #020617;
      padding: 10px;
      margin-top: 10px;
      height: 220px;
      overflow: auto;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>m3u8 Downloader（非ライブ / DRMなし）</h2>

<input id="m3u8" placeholder="https://example.com/video.m3u8">
<button id="start">Download</button>

<pre id="log"></pre>

<!-- ffmpeg.wasm UMD（同一オリジン） -->
<script src="./ffmpeg/ffmpeg.js"></script>

<script>
  const logEl = document.getElementById("log");
  const log = (msg) => {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  };

  const { FFmpeg } = FFmpegWASM;
  const ffmpeg = new FFmpeg();

  document.getElementById("start").onclick = async () => {
    const url = document.getElementById("m3u8").value.trim();
    if (!url) {
      alert("m3u8 URLを入力してください");
      return;
    }

    const btn = document.getElementById("start");
    btn.disabled = true;

    try {
      log("ffmpeg 読み込み中...");

      await ffmpeg.load({
        coreURL: "./ffmpeg/ffmpeg-core.js",
        wasmURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.wasm"
      });

      log("変換開始...");
      await ffmpeg.exec([
        "-i", url,
        "-c", "copy",
        "output.mp4"
      ]);

      log("ファイル取得中...");
      const data = await ffmpeg.readFile("output.mp4");

      const blob = new Blob([data.buffer], { type: "video/mp4" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "video.mp4";
      a.click();

      log("完了！");
    } catch (e) {
      log("エラー: " + e.message);
      console.error(e);
    } finally {
      btn.disabled = false;
    }
  };
</script>

</body>
</html>
